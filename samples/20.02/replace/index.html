<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no, minimal-ui">
		<script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.3.2/pixi.min.js"></script>
		<script src="../../../lib/Pixim.min.js"></script>
		<script src="../../../dist/Pixim-animate-container.js"></script>
	</head>
	<body>
		<script>
			const pRatio = window.devicePixelRatio || 1;
			const app = new Pixim.Application({
				width: 450,
				height: 800,
				antialias: true,
				resolution: pRatio,
				backgroundColor: 0xFFFFFF
			});
			
			const Game = Pixim.Content.create();
			
			Game.setConfig({
				width: 450,
				height: 800
			});
			
			Game.defineImages({
				i: "s.png"
			})
			
			Pixim.animate.defineAnimatesTo(Game, {
				test: {
					basepath: '../class/game/',
					filepath: 'game.js',
					id: '2FA8E0C7230941478CE2CA3DB82DBEDF',
					options: {
						crossOrigin: false
					}
				},
				anim: {
					basepath: '../animation/game/',
					filepath: 'game.js',
					id: '2FA8E0C7230941478CE2CA3DB82DBEDF_1'
				}
			});
			
			createjs.Bitmap.prototype.replaceImage = function(texture) {
				this._pixiData.instance.texture = texture;
			}
			
			createjs.MovieClip.prototype.replaceInstance = function(name, cls) {
				const old = this[name];
				
				if (!old) {
					console.warn(`instance '${name}' was not found.`);
				}
				
				if (!this._hoge) {
					this._hoge = {};
				}
				
				const props = ["x", "y", "scaleX", "scaleY", "rotation", "skewX", "skewY", "regX", "regY", "_off", "alpha"];
				/*if (!this._hoge[name]) {
					this._hoge[name] = this[name];
					
					Object.defineProperty(this, name, {
						get: () => {
							return this._hoge[name];
						},
						set: (value) => {
							this._hoge[name] = value;
						}
					});
				}
				*/
				const instance = this[name] = new cls(old.mode, old.startPosition, old.loop, old.timeline.reversed);
				
				const tweens = this.timeline.tweens;
				for (let i = 0; i < tweens.length; i++) {
					const target = tweens[i].target;
					console.log(target)
					if (Array.isArray(target.state)) {
						for (let j = 0; j < target.state.length; j++) {
							console.log(target)
							if (target.state[j].t === old) {
								target.state[j].t = instance;
							}
						}
					} else if (target === old) {
						console.log(55)
						tweens[i].target = instance;
					}
				}
				
				for (let i = 0; i < props.length; i++) {
					instance[props[i]] = old[props[i]];
				}
				
				if (old.mask) {
					instance.mask = old.mask;
					old.mask = null;
				}
				
				if (old.filters) {
					instance.filters = old.filters;
					old.filters = null;
					
					const nominalBounds = instance.nominalBounds;
					instance.cache(nominalBounds.x - 2, nominalBounds.y - 2, nominalBounds.width + 4, nominalBounds.height + 4);
				}
				
				this.removeChild(old);
			}
			
			class Root extends Pixim.Container {
				constructor($) {
					super();
					
					this.x = 10;
					this.y = 10;
					this.scale.set(0.5);
					
					var lib = $.resources.animates.test;
					
					const container = this.addChild(new Pixim.animate.Container());
					
					this.addChild(new Block('A', lib.A));
					this.addChild(new Block('B', lib.B)).y = 150;
					
					this.addChild(new Block('green', lib.G_A)).y = 300;
					const gb = this.addChild(new Block('red', lib.G_B));
					gb.x = 200; gb.y = 300;
					
					const ainb = this.addChild(new Block('Replace B.red to green', lib.B));
					ainb.y = 450;
					ainb.cjs.replaceInstance('instance', lib.G_A);
					
					const bina = this.addChild(new Block('Replace A.green to red', lib.A));
					bina.y = 600;
					bina.cjs.replaceInstance('instance', lib.G_B);
					
					lib = $.resources.animates.anim;
					this.addChild(new Block('Animation', lib.anim)).y = 750;
					this.addChild(new Block('Image ( === new lib.anim().instance.instance)', lib.bitmap1)).y = 900;
					const r = this.addChild(new Block('replace image (different size)', lib.anim));
					r.y = 1050;
					r.cjs.instance.instance.replaceImage($.resources.images.i);
					
					const r3 = this.addChild(new Block('replace image (same size)', lib.anim));
					r3.y = 1200;
					r3.cjs.instance.instance.replaceImage($.resources.images.i);
					r3.cjs.instance.instance._pixiData.instance.scale.set(32 / r3.cjs.instance.instance._pixiData.instance.width)
					//r.cjs.instance.instance.setTransform(-r.cjs.instance.instance.pixi.width / 2, -r.cjs.instance.instance.pixi.height / 2)
				}
			}
			
			class Block extends Pixim.animate.Container {
				constructor(title, lib) {
					super();
					
					this.addChild(new PIXI.Text(title));
					this.cjs = this.addCreatejs(new lib());
					this.cjs.y = 50;
				}
			}
			
			Game.defineLibraries({
				root: Root
			});
			
			const game = new Game({
				basepath: "."
			});
			
			app
				.fullScreen()
				.attachAsync(game)
				.then(function() {
					app.play();
				});
		</script>
	</div>
	</body>
</html>